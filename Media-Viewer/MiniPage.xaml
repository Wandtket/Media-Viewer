<Page
    x:Class="MediaViewer.MiniPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MediaViewer"
    xmlns:models="using:MediaViewer.Models"
    xmlns:controls="using:MediaViewer.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls"
    SizeChanged="Page_SizeChanged"
    CharacterReceived="Page_CharacterReceived"
    MinWidth="300"
    mc:Ignorable="d">

<Page.Resources>
    <!-- Converter for selected item background -->
    <local:SelectedBackgroundConverter x:Key="SelectedBackgroundConverter"/>
    
    <!-- Converter for play/pause icon -->
    <local:PlayingIconConverter x:Key="PlayingIconConverter"/>
    
    <!-- Converter for playing item color -->
    <local:PlayingColorConverter x:Key="PlayingColorConverter"/>
    
    <!-- Converter for bool to opacity -->
    <local:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
</Page.Resources>

    <Grid Background="#222">
        <Grid.RowDefinitions>
            <RowDefinition Height="48" />
            <RowDefinition Height="*" />
            <RowDefinition Height="100" />
        </Grid.RowDefinitions>

        <!-- Header (now inside NavigationView content) -->
        <Grid Grid.Row="0" Background="#161616" Padding="8,6">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" 
                Orientation="Horizontal" 
                HorizontalAlignment="Left" 
                VerticalAlignment="Center"
                Spacing="8">

                <!-- Toggle buttons for narrow view -->
                <StackPanel x:Name="ViewToggleButtons" Orientation="Horizontal" Visibility="Collapsed">
                    <ToggleButton x:Name="ShowAlbumArtButton" 
                            Background="Transparent" 
                            BorderBrush="Transparent" 
                            IsChecked="True" 
                            Click="ShowAlbumArtButton_Click">
                        <FontIcon Glyph="&#xE768;" Foreground="#FFF" />
                    </ToggleButton>

                    <ToggleButton x:Name="ShowPlaylistButton" 
                            Background="Transparent" 
                            BorderBrush="Transparent" 
                            IsChecked="False" 
                            Click="ShowPlaylistButton_Click">
                        <FontIcon Glyph="&#xE142;" Foreground="#FFF" />
                    </ToggleButton>
                </StackPanel>

                <!-- Playlist Name (Only if user specified) -->
                <TextBlock  x:Name="WindowTitle"
                    Text="Folder" 
                    Margin="5,0,0,0" 
                    FontWeight="Bold"
                    FontSize="18"
                    VerticalAlignment="Center"/>

            </StackPanel>

            <!-- Cancel Selection Button (visible only in multi-select mode) -->
            <Button x:Name="CancelSelectionButton"
            Grid.Column="2"
            Content="Cancel Selection"
            Click="CancelSelection_Click"
            Visibility="Collapsed"
            VerticalAlignment="Center"
            Style="{StaticResource AccentButtonStyle}"/>

            <TextBlock Grid.Column="1" Text="" HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0" />
        </Grid>
        
        <!-- Main content -->
        <Grid x:Name="ContentGrid" Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="PlaylistColumn" Width="auto" MinWidth="300" />
                <ColumnDefinition x:Name="AlbumArtColumn" Width="*" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="auto"/>
            </Grid.RowDefinitions>
            
            <!-- Playlist -->
            <Border x:Name="PlaylistView" 
                    Grid.Column="0" 
                    Grid.Row="0"
                    Background="#2A2A2A" 
                    Padding="8" 
                    BorderBrush="#1A1A1A" 
                    BorderThickness="0,0,1,0">

                <ListView x:Name="FileList" 
                          Background="Transparent" 
                          BorderThickness="0"
                          ItemsSource="{x:Bind playlist, Mode=OneWay}"
                          SelectionMode="Single"
                          SelectionChanged="FileList_SelectionChanged">
                    <ListView.Header>
                        <AutoSuggestBox PlaceholderText="Search" 
                                  QueryIcon="Find" 
                                  Margin="0,0,0,5"
                                  TextChanged="SearchBox_TextChanged"/>
                    </ListView.Header>

                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:AudioPlaylistItem">
                            <Grid Padding="5,8,15,8" 
                                    ColumnSpacing="10">
                                <!-- Remove: Background="{x:Bind IsSelected, Mode=OneWay, Converter={StaticResource SelectedBackgroundConverter}}" -->
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="32" />
                                    <ColumnDefinition Width="28" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="60" />
                                </Grid.ColumnDefinitions>

                                <!-- Track Number -->
                                <TextBlock Grid.Column="0"
                                             Text="{x:Bind TrackNumber}"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Right"
                                             FontSize="13"
                                             Opacity="0.6"
                                             Margin="0,0,8,0"/>

                                <!-- Play Button / Now Playing Indicator -->
                                <Button Grid.Column="1"
                                      Width="28"
                                      Height="28"
                                      Padding="0"
                                      Background="Transparent"
                                      BorderBrush="Transparent"
                                      Click="PlayTrackButton_Click"
                                      Tag="{x:Bind}"
                                      VerticalAlignment="Center">
                                    <FontIcon Glyph="{x:Bind IsPlaying, Mode=OneWay, Converter={StaticResource PlayingIconConverter}}" 
                                          FontSize="14"
                                           Foreground="{x:Bind IsCurrentTrack, Mode=OneWay, Converter={StaticResource PlayingColorConverter}}"/>
                                </Button>

                                <!-- Track Info -->
                                <StackPanel Grid.Column="2" 
                                          VerticalAlignment="Center"
                                          Spacing="2">
                                    <TextBlock Text="{x:Bind DisplayTitle, Mode=OneWay}" 
                                                 FontWeight="SemiBold"
                                                 TextTrimming="CharacterEllipsis"
                                                 FontSize="13"/>
                                    <TextBlock FontSize="11"
                                         Opacity="0.7"
                                         TextTrimming="CharacterEllipsis">
                                        <Run Text="{x:Bind DisplayArtist, Mode=OneWay}"/>
                                        <Run Text=" • "/>
                                        <Run Text="{x:Bind Properties.Album, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Duration -->
                                <TextBlock Grid.Column="3" 
                                     Text="{x:Bind DisplayDuration, Mode=OneWay}"
                                     HorizontalAlignment="Right" 
                                     VerticalAlignment="Center"
                                     FontSize="12"
                                     Opacity="0.6"/>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,0,0,1"/>

                            <!-- Multi-select styling improvements -->
                            <Setter Property="Background" Value="Transparent"/>

                            <!-- Override default selection visuals -->
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListViewItem">
                                        <ListViewItemPresenter
                                            ContentTransitions="{TemplateBinding ContentTransitions}"
                                            Control.IsTemplateFocusTarget="True"
                                            SelectionCheckMarkVisualEnabled="True"
                                            CheckBrush="{ThemeResource SystemAccentColor}"
                                            CheckBoxBrush="{ThemeResource SystemControlForegroundBaseMediumHighBrush}"
                                            CheckMode="{ThemeResource ListViewItemCheckMode}"
                                            ContentMargin="{TemplateBinding Padding}"
                                            DisabledOpacity="{ThemeResource ListViewItemDisabledThemeOpacity}"
                                            DragBackground="{ThemeResource ListViewItemDragBackground}"
                                            DragForeground="{ThemeResource ListViewItemDragForeground}"
                                            DragOpacity="{ThemeResource ListViewItemDragThemeOpacity}"
                                            FocusBorderBrush="{ThemeResource SystemControlForegroundAltHighBrush}"
                                            FocusVisualMargin="{TemplateBinding FocusVisualMargin}"
                                            FocusSecondaryBorderBrush="{ThemeResource SystemControlForegroundBaseHighBrush}"
                                            PlaceholderBackground="{ThemeResource ListViewItemPlaceholderBackground}"
                                            PointerOverBackground="#1AFFFFFF"
                                            PointerOverForeground="{ThemeResource ListViewItemForegroundPointerOver}"
                                            PressedBackground="#0DFFFFFF"
                                            ReorderHintOffset="{ThemeResource ListViewItemReorderHintThemeOffset}"
                                            RevealBackground="{ThemeResource ListViewItemRevealBackground}"
                                            RevealBorderBrush="{ThemeResource ListViewItemRevealBorderBrush}"
                                            RevealBorderThickness="{ThemeResource ListViewItemRevealBorderThemeThickness}"
                                            SelectedBackground="#40808080"
                                            SelectedForeground="{ThemeResource ListViewItemForegroundSelected}"
                                            SelectedPointerOverBackground="#60808080"
                                            SelectedPressedBackground="#50808080"
                                            VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
            </Border>

            <CommandBar x:Name="PlaylistCommandBar" 
                        Grid.Row="1" 
                        Grid.Column="0">
                <CommandBar.Content>
                    <StackPanel 
                        Orientation="Horizontal" 
                        Spacing="8" 
                        Margin="12,15,0,0">
                        <TextBlock x:Name="TrackCountText" 
                               Text="0 Tracks" 
                               VerticalAlignment="Center"/>
                        <TextBlock Text="•" 
                               VerticalAlignment="Center" 
                               Opacity="0.5"/>
                        <TextBlock x:Name="TotalDurationText" 
                               Text="0:00" 
                               VerticalAlignment="Center"/>
                    </StackPanel>
                </CommandBar.Content>

                <CommandBar.PrimaryCommands>
                    <AppBarButton Icon="OpenLocal" Label="Open Folder"/>
                </CommandBar.PrimaryCommands>

                <CommandBar.SecondaryCommands>
                    <AppBarButton Label="Create new Playlist" Icon="Add"/>
                    <AppBarSeparator/>
                    <AppBarButton Label="Copy as Path">
                        <AppBarButton.Icon>
                            <FontIcon Glyph="&#xE62F;"/>
                        </AppBarButton.Icon>
                    </AppBarButton>
                    <AppBarButton Label="Show in File Explorer" Icon="Folder"/>
                    <AppBarSeparator/>
                    <AppBarButton Label="Settings" Icon="Setting"/>
                </CommandBar.SecondaryCommands>
            </CommandBar>
            
            <!-- Album art -->
            <Pivot x:Name="MetaDataView" 
                   Background="#2B2B2B" 
                   Grid.Column="1"
                   Grid.RowSpan="2">
                <Pivot.DataContext>
                    <models:MediaProperties/>
                </Pivot.DataContext>
                
                <PivotItem Header="Artwork">
                    <Viewbox Stretch="Uniform">
                        <Grid Width="520" Height="420">
                            <Image x:Name="AlbumArtwork" 
                                   Stretch="UniformToFill"
                                   AllowDrop="True"
                                   DragOver="AlbumArtwork_DragOver"
                                   Drop="AlbumArtwork_Drop"
                                   Tapped="AlbumArtwork_Tapped"/>

                            <Border x:Name="AlbumPlaceholder"
                                Background="#FFF" 
                                HorizontalAlignment="Stretch" 
                                VerticalAlignment="Stretch" 
                                BorderThickness="8" 
                                BorderBrush="#2B2B2B">
                                <TextBlock Text="Add Album Art" 
                                    HorizontalAlignment="Center" 
                                    VerticalAlignment="Center" 
                                    Foreground="#999" 
                                    FontSize="20" />
                            </Border>
                        </Grid>
                    </Viewbox>
                </PivotItem>
                <PivotItem Header="Lyrics">
                    <Grid Padding="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Song Lyrics" 
                                 FontSize="18" 
                                 FontWeight="SemiBold" 
                                 Margin="0,0,0,15"
                                 Grid.Row="0"/>

                        <RichEditBox x:Name="LyricsRichEditBox"
                                   Grid.Row="1"
                                   PlaceholderText="Enter song lyrics here..."
                                   AcceptsReturn="True"
                                   TextWrapping="Wrap"
                                   DataContextChanged="LyricsRichEditBox_DataContextChanged"
                                   FontFamily="Segoe UI"
                                   FontSize="14"/>

                        <StackPanel Grid.Row="2" 
                                  Orientation="Horizontal" 
                                  HorizontalAlignment="Right" 
                                  Spacing="10"
                                  Margin="0,10,0,0">
                            <Button x:Name="ClearLyricsButton"
                                  Content="Clear"
                                  Click="ClearLyricsButton_Click"/>
                            <Button x:Name="SearchLyricsButton"
                                  Content="Search Online"
                                  Style="{StaticResource AccentButtonStyle}"
                                  Click="SearchLyricsButton_Click"/>
                        </StackPanel>
                    </Grid>
                </PivotItem>
                <PivotItem Header="Properties">
                    <ScrollViewer Padding="20,15,20,15">
                        <StackPanel Spacing="20" MaxWidth="500">
                            
                            <!-- Title -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <SymbolIcon Symbol="MusicInfo" 
                                          Grid.Column="0"
                                          VerticalAlignment="Center"
                                          Margin="0,0,12,0"
                                          ToolTipService.ToolTip="Title"/>
                                
                                <TextBox x:Name="TitleTextBox"
                                       Grid.Column="1"
                                       Header="Title"
                                       PlaceholderText="Enter song title"
                                       TextChanged="MetaTextBox_TextChanged"/>
                            </Grid>

                            <!-- Artist -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <FontIcon Glyph="&#xE77B;" 
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        Margin="0,0,12,0"
                                        ToolTipService.ToolTip="Artist"/>

                                <TextBox x:Name="ArtistTextBox"
                                    Grid.Column="1"
                                    Header="Artist"
                                    PlaceholderText="Enter artist name"
                                    TextChanged="MetaTextBox_TextChanged"/>
                                
                                <Button x:Name="ApplyArtistButton"
                                        Grid.Column="2"
                                        Click="ApplyMetadataToSelected_Click"
                                        Tag="Artist"
                                        VerticalAlignment="Bottom"
                                        ToolTipService.ToolTip="Apply artist to multiple files."
                                        Margin="10,0,0,0">
                                    <FontIcon Glyph="&#xE762;"/>
                                </Button>
                            </Grid>

                            <!-- Album -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <FontIcon Glyph="&#xE93C;" 
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        Margin="0,0,12,0"
                                        ToolTipService.ToolTip="Album"/>

                                    <TextBox x:Name="AlbumTextBox" 
                                         Grid.Column="1"
                                         Header="Album" 
                                         PlaceholderText="Enter album name"
                                         TextChanged="MetaTextBox_TextChanged"/>
                                
                                <Button x:Name="ApplyAlbumButton"
                                        Grid.Column="2"
                                        Click="ApplyMetadataToSelected_Click"
                                        Tag="Album"
                                        VerticalAlignment="Bottom"
                                        ToolTipService.ToolTip="Apply album to multiple files."
                                        Margin="10,0,0,0">
                                    <FontIcon Glyph="&#xE762;"/>
                                </Button>
                            </Grid>

                            <!-- Genre -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <FontIcon Glyph="&#xEC4F;" 
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        Margin="0,0,12,0"
                                        ToolTipService.ToolTip="Genre"/>
                                

                                <TextBox x:Name="GenreTextBox"
                                       Grid.Column="1"
                                       Header="Genre"
                                       PlaceholderText="Enter genre"
                                       TextChanged="MetaTextBox_TextChanged"/>

                                <Button x:Name="ApplyGenreButton"                                       
                                        Grid.Column="2"
                                        Click="ApplyMetadataToSelected_Click"
                                        Tag="Genre"
                                        VerticalAlignment="Bottom"
                                        Margin="10,0,0,0"
                                        ToolTipService.ToolTip="Apply genre to multiple files.">
                                    <FontIcon Glyph="&#xE762;"/>
                                </Button>
                            </Grid>

                            <!-- Year -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <SymbolIcon Symbol="Calendar" 
                                          Grid.Column="0"
                                          VerticalAlignment="Center"
                                          Margin="0,0,12,0"
                                          ToolTipService.ToolTip="Year"/>
                                
                                <NumberBox x:Name="YearNumberBox"
                                         Grid.Column="1"
                                         Header="Year"
                                         PlaceholderText="Enter year"
                                         SpinButtonPlacementMode="Inline"
                                         Minimum="1900"
                                         Maximum="2100"
                                         ValueChanged="YearNumberBox_ValueChanged"/>
                            </Grid>

                            <!-- Track Number -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <FontIcon Glyph="&#xE8FD;" 
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        Margin="0,0,12,0"
                                        ToolTipService.ToolTip="Track Number"/>
                                
                                <NumberBox x:Name="TrackNumberBox"
                                         Grid.Column="1"
                                         Header="Track Number"
                                         PlaceholderText="Enter track #"
                                         SpinButtonPlacementMode="Inline"
                                         Minimum="0"
                                         ValueChanged="TrackNumberBox_ValueChanged"/>
                            </Grid>

                            <!-- Comments -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <SymbolIcon Symbol="AlignLeft" 
                                          Grid.Column="0"
                                          VerticalAlignment="Top"
                                          Margin="0,8,12,0"
                                          ToolTipService.ToolTip="Comments"/>
                                
                                <RichEditBox x:Name="CommentsRichEditBox"
                                           Grid.Column="1"
                                           Header="Comments"
                                           PlaceholderText="Add comments"
                                           MinHeight="80"
                                           MaxHeight="150"
                                           DataContextChanged="CommentsRichEditBox_DataContextChanged"/>
                            </Grid>

                            <!-- Rating -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <SymbolIcon Symbol="LikeDislike" 
                                          Grid.Column="0"
                                          VerticalAlignment="Center"
                                          Margin="0,0,12,0"
                                          ToolTipService.ToolTip="Rating"/>
                                
                                <RatingControl x:Name="FileRatingControl"
                                             Grid.Column="1"
                                             Caption="Rating"
                                             DataContextChanged="FileRatingControl_DataContextChanged"
                                             ValueChanged="FileRatingControl_ValueChanged"/>
                            </Grid>

                            <!-- File Information Section -->
                            <Border BorderThickness="0,1,0,0" 
                                  BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                  Padding="0,20,0,0">
                                <StackPanel Spacing="15">
                                    <TextBlock Text="File Information" 
                                             FontWeight="SemiBold"
                                             FontSize="16"/>
                                    
                                    <!-- File Path -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="Path:" 
                                                 Grid.Column="0"
                                                 Opacity="0.7"/>
                                        <TextBlock x:Name="FilePathText"
                                                 Grid.Column="1"
                                                 TextWrapping="Wrap"
                                                 IsTextSelectionEnabled="True"/>
                                    </Grid>

                                    <!-- File Size -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="Size:" 
                                                 Grid.Column="0"
                                                 Opacity="0.7"/>
                                        <TextBlock x:Name="FileSizeText"
                                                 Grid.Column="1"/>
                                    </Grid>

                                    <!-- Bit Rate -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="Bit Rate:" 
                                                 Grid.Column="0"
                                                 Opacity="0.7"/>
                                        <TextBlock x:Name="BitRateText"
                                                 Grid.Column="1"/>
                                    </Grid>

                                    <!-- Sample Rate -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="Sample Rate:" 
                                                 Grid.Column="0"
                                                 Opacity="0.7"/>
                                        <TextBlock x:Name="SampleRateText"
                                                 Grid.Column="1"/>
                                    </Grid>

                                    <!-- Duration -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="Duration:" 
                                                 Grid.Column="0"
                                                 Opacity="0.7"/>
                                        <TextBlock x:Name="DurationText"
                                                 Grid.Column="1"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </PivotItem>
            </Pivot>

            <toolkit:GridSplitter 
                        x:Name="ContentSplitter"
                        Grid.Column="1"
                        Width="15"
                        HorizontalAlignment="Left"
                        ResizeBehavior="BasedOnAlignment"
                        ResizeDirection="Columns">

                <toolkit:GridSplitter.RenderTransform>
                    <TranslateTransform X="-7" />
                </toolkit:GridSplitter.RenderTransform>
            </toolkit:GridSplitter>
        </Grid>


        <!-- Bottom area: transport UI container -->
        <Grid Grid.Row="2">
            <!-- Single-select transport bar (adopts selected item when in single mode) -->
            <Border x:Name="SingleTransportBar" 
                    Background="#0F0F0F" 
                    BorderBrush="#222" 
                    BorderThickness="1,1,1,0" 
                    Padding="12" 
                    HorizontalAlignment="Stretch" 
                    VerticalAlignment="Stretch">

                <Grid>
                    <VisualStateManager.VisualStateGroups>
                        <VisualStateGroup x:Name="TransportSizeStates">
                            <VisualState x:Name="WideTransport">
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="600" />
                                </VisualState.StateTriggers>
                                <VisualState.Setters>
                                    <!-- Wide layout: Single row with 3 columns -->
                                    <Setter Target="TransportGrid.RowDefinitions[0].Height" Value="*" />
                                    <Setter Target="TransportGrid.RowDefinitions[1].Height" Value="0" />
                                    <Setter Target="LeftControls.(Grid.Row)" Value="0" />
                                    <Setter Target="LeftControls.(Grid.Column)" Value="0" />
                                    <Setter Target="CenterControls.(Grid.Row)" Value="0" />
                                    <Setter Target="CenterControls.(Grid.Column)" Value="1" />
                                    <Setter Target="CenterControls.(Grid.ColumnSpan)" Value="1" />
                                    <Setter Target="RightControls.(Grid.Row)" Value="0" />
                                    <Setter Target="RightControls.(Grid.Column)" Value="2" />
                                    <Setter Target="RightControls.Visibility" Value="Visible" />
                                    <Setter Target="TransportTitle.Visibility" Value="Visible" />
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="NarrowTransport">
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="0" />
                                </VisualState.StateTriggers>
                                <VisualState.Setters>
                                    <!-- Narrow layout: 2 rows, timeline on top spanning full width, controls below -->
                                    <Setter Target="TransportGrid.RowDefinitions[0].Height" Value="Auto" />
                                    <Setter Target="TransportGrid.RowDefinitions[1].Height" Value="*" />
                                    <Setter Target="LeftControls.(Grid.Row)" Value="1" />
                                    <Setter Target="LeftControls.(Grid.Column)" Value="0" />
                                    <Setter Target="LeftControls.(Grid.ColumnSpan)" Value="3" />
                                    <Setter Target="LeftControls.HorizontalAlignment" Value="Center" />
                                    <Setter Target="CenterControls.(Grid.Row)" Value="0" />
                                    <Setter Target="CenterControls.(Grid.Column)" Value="0" />
                                    <Setter Target="CenterControls.(Grid.ColumnSpan)" Value="3" />
                                    <Setter Target="RightControls.Visibility" Value="Collapsed" />
                                    <Setter Target="TransportTitle.Visibility" Value="Collapsed" />
                                    <Setter Target="ProgressGrid.Margin" Value="0" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateManager.VisualStateGroups>

                    <Grid x:Name="TransportGrid" ColumnSpacing="15">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="0" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.Resources>
                            <Style TargetType="Button" >
                                <Setter Target="Background" Value="Transparent"/>
                                <Setter Target="BorderBrush" Value="Transparent"/>
                            </Style>
                        </Grid.Resources>

                        <!-- Center: time, progress, title (top row in narrow, middle column in wide) -->
                        <StackPanel x:Name="CenterControls" 
                                    Grid.Row="0" 
                                    Grid.Column="1" 
                                    Orientation="Vertical" 
                                    VerticalAlignment="Center" 
                                    HorizontalAlignment="Stretch">

                            <TextBlock x:Name="TransportTitle" 
                                        Text="Unknown - Scarlet Fire" 
                                        FontWeight="SemiBold" 
                                        HorizontalAlignment="Center" 
                                        Margin="0,0,0,6" />

                            <Grid x:Name="ProgressGrid" ColumnSpacing="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock x:Name="CurrentTimeText" 
                                            Text="00:00" 
                                            VerticalAlignment="Center" 
                                            FontSize="12" />

                                <Grid Grid.Column="1">
                                    <!-- Canvas for Mark In/Out markers -->
                                    <Canvas x:Name="MarkInOutCanvas"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Center"
                                            Height="32"
                                            IsHitTestVisible="False"/>

                                    <!-- Progress Slider -->
                                    <Slider x:Name="ProgressSlider" 
                                            ValueChanged="ProgressSlider_ValueChanged"
                                            Minimum="0"
                                            Maximum="100" 
                                            Value="0"
                                            SizeChanged="ProgressSlider_SizeChanged"/>
                                </Grid>

                                <TextBlock x:Name="TotalTimeText" 
                                            Grid.Column="2"
                                            Text="02:22" 
                                            VerticalAlignment="Center" 
                                            FontSize="12" />
                            </Grid>
                        </StackPanel>

                        <!-- Left controls: prev/play/next (bottom row in narrow, left column in wide) -->
                        <StackPanel x:Name="LeftControls" 
                                    Grid.Row="0" 
                                    Grid.Column="0" 
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center" 
                                    HorizontalAlignment="Left" 
                                    Spacing="12">

                            <Button x:Name="PrevButton" 
                                    Click="PrevButton_Click"
                                    Width="48" 
                                    Height="48">
                                <FontIcon Glyph="&#xE100;" 
                                            FontSize="20"/>
                            </Button>

                            <Button x:Name="PlayPauseButton" 
                                    Click="PlayPauseButton_Click"
                                    Width="56" 
                                    Height="56">
                                <FontIcon Glyph="&#xE768;" FontSize="24" />
                            </Button>

                            <Button x:Name="NextButton" 
                                    Click="NextButton_Click"
                                    Width="48" 
                                    Height="48">

                                <FontIcon Glyph="&#xE893;" FontSize="20"/>
                            </Button>
                        </StackPanel>

                        <!-- Right controls: repeat/shuffle/volume/more (hidden in narrow, right column in wide) -->
                        <StackPanel x:Name="RightControls" 
                                    Grid.Row="0" 
                                    Grid.Column="2" 
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center" 
                                    HorizontalAlignment="Right" 
                                    Spacing="12">

                            <Button x:Name="RepeatButton"
                                    Click="RepeatButton_Click">
                                <FontIcon Glyph="&#xE8EE;"/>
                            </Button>

                            <Button x:Name="ShuffleButton"
                                    Click="ShuffleButton_Click">
                                <FontIcon Glyph="&#xE8B1;" />
                            </Button>

                            <Button x:Name="VolumeButton">
                                <FontIcon Glyph="&#xE993;" />
                                <Button.Flyout>
                                    <Flyout Opening="VolumeFlyout_Opening" Placement="Top">
                                        <StackPanel Width="200" Spacing="10">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <FontIcon Glyph="&#xE992;" 
                                                        Grid.Column="0"
                                                        FontSize="16"
                                                        Margin="0,0,10,0"/>

                                                <Slider x:Name="VolumeSlider"
                                                      Grid.Column="1"
                                                      Minimum="0"
                                                      Maximum="100"
                                                      Value="100"
                                                      ValueChanged="VolumeSlider_ValueChanged"
                                                      VerticalAlignment="Center"/>

                                                <FontIcon Glyph="&#xE995;" 
                                                        Grid.Column="2"
                                                        FontSize="16"
                                                        Margin="10,0,0,0"/>
                                            </Grid>

                                            <TextBlock x:Name="VolumePercentText"
                                                     Text="100%"
                                                     HorizontalAlignment="Center"
                                                     FontSize="14"
                                                     Opacity="0.8"/>

                                            <Button x:Name="MuteButton"
                                                  HorizontalAlignment="Stretch"
                                                  Click="MuteButton_Click">
                                                <Button.Content>
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <FontIcon x:Name="MuteIcon" Glyph="&#xE74F;" FontSize="14"/>
                                                        <TextBlock x:Name="MuteText" Text="Mute"/>
                                                    </StackPanel>
                                                </Button.Content>
                                            </Button>
                                        </StackPanel>
                                    </Flyout>
                                </Button.Flyout>
                            </Button>

                            <Button x:Name="MoreButton">
                                <Button.Content>
                                    <FontIcon Glyph="&#xE712;" />
                                </Button.Content>
                                <Button.Flyout>
                                    <MenuFlyout>
                                        <MenuFlyoutItem Text="Edit">
                                            <MenuFlyoutItem.Icon>
                                                <SymbolIcon Symbol="Edit"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutSeparator/>

                                        <MenuFlyoutItem Text="Copy File">
                                            <MenuFlyoutItem.Icon>
                                                <SymbolIcon Symbol="Copy"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutItem Text="Copy as Path">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE62F;"/>
                                            </MenuFlyoutItem.Icon>
                                            <MenuFlyoutItem.KeyboardAccelerators>
                                                <KeyboardAccelerator Modifiers="Control" Key="C"/>
                                            </MenuFlyoutItem.KeyboardAccelerators>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutItem Text="Show in File Explorer">
                                            <MenuFlyoutItem.Icon>
                                                <SymbolIcon Symbol="OpenFile"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutSeparator/>
                                        
                                        <MenuFlyoutItem x:Name='MarkInButton'
                                                        Text="Mark In"
                                                        VerticalAlignment="Center"
                                                        MediaTransportControlsHelper.DropoutOrder='3'
                                                        KeyboardAcceleratorTextOverride="Press ["
                                                        Click="MarkInButton_Click"
                                                        Margin="0,0,0,0">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph='&#xEDE2;' RenderTransformOrigin="0.5,0.5">
                                                    <FontIcon.RenderTransform>
                                                        <ScaleTransform ScaleX="-1"/>
                                                    </FontIcon.RenderTransform>
                                                </FontIcon>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutItem x:Name='MarkOutButton'
                                                         Text="Mark Out"
                                                         VerticalAlignment="Center"
                                                         MediaTransportControlsHelper.DropoutOrder='3'
                                                         KeyboardAcceleratorTextOverride="Press ]"
                                                         Click="MarkOutButton_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph='&#xEDE2;' />
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutItem x:Name='ClearMarksButton'
                                                         Text="Clear Mark In/Out"
                                                         VerticalAlignment="Center"
                                                         MediaTransportControlsHelper.DropoutOrder='3'
                                                         KeyboardAcceleratorTextOverride="Press \"
                                                         Click="ClearMarksButton_Click">
                                            <MenuFlyoutItem.Icon>
                                                <SymbolIcon Symbol="Clear" />
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>

                                        <MenuFlyoutSeparator/>

                                        <MenuFlyoutSubItem Text="Playback Rate">
                                            <MenuFlyoutSubItem.Icon>
                                                <FontIcon Glyph="&#xEC57;"/>
                                            </MenuFlyoutSubItem.Icon>
                                            <MenuFlyoutSubItem.Items>
                                                <RadioMenuFlyoutItem Text="0.25x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="0.25"/>
                                                <RadioMenuFlyoutItem Text="0.50x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="0.50"/>
                                                <RadioMenuFlyoutItem Text="0.75x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="0.75"/>
                                                <RadioMenuFlyoutItem Text="1.00x" GroupName="PlaybackRate" IsChecked="True" Click="PlaybackRate_Click" Tag="1.00"/>
                                                <RadioMenuFlyoutItem Text="1.25x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="1.25"/>
                                                <RadioMenuFlyoutItem Text="1.50x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="1.50"/>
                                                <RadioMenuFlyoutItem Text="1.75x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="1.75"/>
                                                <RadioMenuFlyoutItem Text="2.00x" GroupName="PlaybackRate" Click="PlaybackRate_Click" Tag="2.00"/>
                                            </MenuFlyoutSubItem.Items>
                                        </MenuFlyoutSubItem>

                                        <MenuFlyoutSubItem Text="Repeat Delay">
                                            <MenuFlyoutSubItem.Icon>
                                                <FontIcon Glyph="&#xE916;"/>
                                            </MenuFlyoutSubItem.Icon>
                                            <MenuFlyoutSubItem.Items>
                                                <MenuFlyoutItem>
                                                    <MenuFlyoutItem.Template>
                                                        <ControlTemplate TargetType="MenuFlyoutItem">
                                                            <StackPanel Padding="15,15,15,5" Spacing="10" Width="220">
                                                                <TextBlock Text="Repeat Delay" 
                                                                           FontWeight="SemiBold"
                                                                           FontSize="14"/>

                                                                <StackPanel Orientation="Horizontal" Spacing="5">
                                                                    <Slider x:Name="RepeatDelaySlider"
                                                                            Header="Seconds"
                                                                            Width="150"
                                                                            Minimum="0"
                                                                            Maximum="10"
                                                                            Value="0"
                                                                            StepFrequency="0.5"
                                                                            SmallChange="0.5"
                                                                            LargeChange="1"
                                                                            TickFrequency="1"
                                                                            TickPlacement="Outside"
                                                                            Loaded="RepeatDelaySlider_Loaded"
                                                                            ValueChanged="RepeatDelaySlider_ValueChanged"/>

                                                                    <TextBlock x:Name="RepeatDelayText"
                                                                               Text="0.0s" 
                                                                               VerticalAlignment="Center"
                                                                               Margin="0,15,0,0"
                                                                               FontSize="14"
                                                                               FontWeight="SemiBold"
                                                                               MinWidth="45"/>
                                                                </StackPanel>

                                                                <TextBlock Text="Delay between repeating tracks."
                                                                           FontSize="11"
                                                                           Opacity="0.7"
                                                                           TextWrapping="Wrap"
                                                                           Margin="0,5,0,0"/>
                                                            </StackPanel>
                                                        </ControlTemplate>
                                                    </MenuFlyoutItem.Template>
                                                </MenuFlyoutItem>
                                            </MenuFlyoutSubItem.Items>
                                        </MenuFlyoutSubItem>

                                        <MenuFlyoutSubItem Text="Stereo Balance">
                                            <MenuFlyoutSubItem.Icon>
                                                <FontIcon Glyph="&#xF270;"/>
                                            </MenuFlyoutSubItem.Icon>
                                            <MenuFlyoutSubItem.Items>
                                                <MenuFlyoutItem>
                                                    <MenuFlyoutItem.Template>
                                                        <ControlTemplate TargetType="MenuFlyoutItem">
                                                            <StackPanel Padding="15,15,15,5" Spacing="10" Width="220">
                                                                <TextBlock Text="Stereo Balance" 
                                                                   FontWeight="SemiBold"
                                                                   FontSize="14"/>

                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <Slider x:Name="StereoPanSlider"
                                                                                Grid.Column="0"
                                                                                Minimum="-100"
                                                                                Maximum="100"
                                                                                Value="0"
                                                                                TickFrequency="25"
                                                                                TickPlacement="Outside"
                                                                                SmallChange="5"
                                                                                LargeChange="25"
                                                                                ValueChanged="StereoPanSlider_ValueChanged"/>

                                                                    <Button x:Name="PanCenterButton"
                                                                                Grid.Column="1"
                                                                                Content="Center"
                                                                                Click="PanCenterButton_Click"
                                                                                MinWidth="60"
                                                                                Margin="10,0,0,0"
                                                                                FontSize="12"/>
                                                                </Grid>

                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock Text="L" 
                                                                           Grid.Column="0"
                                                                           HorizontalAlignment="Left"
                                                                           FontSize="12"
                                                                           Opacity="0.7"/>

                                                                    <TextBlock x:Name="PanValueText"
                                                                               Text="Center" 
                                                                               Grid.Column="1"
                                                                               HorizontalAlignment="Center"
                                                                               FontSize="12"
                                                                               FontWeight="SemiBold"/>

                                                                    <TextBlock Text="R" 
                                                                       Grid.Column="2"
                                                                       HorizontalAlignment="Right"
                                                                       FontSize="12"
                                                                       Opacity="0.7"/>
                                                                </Grid>

                                                                <TextBlock Text="Adjust which ear receives more audio"
                                                                               FontSize="11"
                                                                               Opacity="0.7"
                                                                               TextWrapping="Wrap"
                                                                               Margin="0,5,0,0"/>
                                                            </StackPanel>
                                                        </ControlTemplate>
                                                    </MenuFlyoutItem.Template>
                                                </MenuFlyoutItem>
                                            </MenuFlyoutSubItem.Items>
                                        </MenuFlyoutSubItem>

                                        <MenuFlyoutSubItem Text="Effects">
                                            <MenuFlyoutSubItem.Icon>
                                                <FontIcon Glyph="&#xF4A5;"/>
                                            </MenuFlyoutSubItem.Icon>
                                            <MenuFlyoutSubItem.Items>
                                                <MenuFlyoutItem>
                                                    <MenuFlyoutItem.Template>
                                                        <ControlTemplate TargetType="MenuFlyoutItem">
                                                            <StackPanel Padding="15,15,15,5" Spacing="10" Width="220">
                                                                <ToggleSwitch x:Name="ReverbEnabledToggle"
                                                                      OnContent="Enabled" 
                                                                      OffContent="Enabled"
                                                                      Header="Reverb"
                                                                      IsOn="False"
                                                                      Loaded="ReverbEnabledToggle_Loaded"
                                                                      Toggled="ReverbEnabledToggle_Toggled"
                                                                      HorizontalAlignment="Left"/>

                                                                <StackPanel Orientation="Horizontal" Spacing="5">
                                                                    <Slider x:Name="ReverbAmountSlider"
                                                                            Header="Amount"
                                                                            Width="150"
                                                                            Minimum="0"
                                                                            Maximum="100"
                                                                            Value="50"
                                                                            SmallChange="1"
                                                                            LargeChange="10"
                                                                            Loaded="ReverbAmountSlider_Loaded"
                                                                            ValueChanged="ReverbAmountSlider_ValueChanged"/>

                                                                    <TextBlock x:Name="ReverbPercentText"
                                                                           Text="50%" 
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,15,0,0"
                                                                           FontSize="14"/>
                                                                </StackPanel>

                                                                <TextBlock Text="Adjust reverb effect intensity"
                                                                   FontSize="11"
                                                                   Opacity="0.7"
                                                                   TextWrapping="Wrap"
                                                                   Margin="0,5,0,0"/>
                                                            </StackPanel>
                                                        </ControlTemplate>
                                                    </MenuFlyoutItem.Template>
                                                </MenuFlyoutItem>

                                                <MenuFlyoutSeparator/>

                                                <MenuFlyoutItem>
                                                    <MenuFlyoutItem.Template>
                                                        <ControlTemplate TargetType="MenuFlyoutItem">
                                                            <StackPanel Padding="15,15,15,5" Spacing="10" Width="220">
                                                                <ToggleSwitch x:Name="IsolationEnabledToggle"
                                                                            OnContent="Enabled" 
                                                                            OffContent="Enabled"
                                                                            Header="Isolation"
                                                                            IsOn="False"
                                                                            Loaded="IsolationEnabledToggle_Loaded"
                                                                            Toggled="IsolationEnabledToggle_Toggled"
                                                                            HorizontalAlignment="Left"/>

                                                                <TextBlock Text="Simulates hearing audio from inside an isolated room."
                                                                             FontSize="11"
                                                                             Opacity="0.7"
                                                                             TextWrapping="Wrap"
                                                                             Margin="0,5,0,0"/>
                                                            </StackPanel>
                                                        </ControlTemplate>
                                                    </MenuFlyoutItem.Template>
                                                </MenuFlyoutItem>

                                            </MenuFlyoutSubItem.Items>
                                        </MenuFlyoutSubItem>
                                        
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>

                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- Per-item AudioPlayer reserved for each playlist item. Keep collapsed by default; code will show/hide as needed. -->
            <controls:AudioPlayer x:Name="AudioPlay" Visibility="Collapsed" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />
        </Grid>
    </Grid>

</Page>