<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="MediaViewer.Controls.VisualPlayer"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MediaViewer.Controls"
    xmlns:ext="using:MediaViewer.Extensions"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    xmlns:converters="using:MediaViewer.Converters"
    mc:Ignorable="d"
    x:Name="VisualControl">


    <Grid>

        <local:VisualCanvas x:Name="FreeMoveImageCanvas"
            PointerPressed="FreeMoveCanvas_PointerPressed"
            PointerMoved="FreeMoveCanvas_PointerMoved"
            PointerReleased="FreeMoveCanvas_PointerReleased"
            PointerExited="FreeMoveCanvas_PointerReleased"
            Tag="{Binding ElementName=VisualPlayerImageScrollViewer}"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch">
        </local:VisualCanvas>

        <ScrollViewer x:Name="VisualPlayerImageScrollViewer"
              HorizontalScrollMode="Enabled"
              VerticalScrollMode="Enabled"
              HorizontalScrollBarVisibility="Hidden"
              VerticalScrollBarVisibility="Hidden"
              Loaded="ImageScrollViewer_Loaded"
              PointerMoved="ScrollViewer_PointerMoved"
              PointerExited="ScrollViewer_PointerExited"
              PointerEntered="ScrollViewer_PointerEntered"
              LostFocus="ScrollViewer_LostFocus"
              ZoomMode="Enabled"    
              Tag="{Binding ElementName=FreeMoveImageCanvas}"
              Visibility="{Binding ElementName=ImageElement, 
                            Path=Visibility, Mode=OneWay,
                            UpdateSourceTrigger=PropertyChanged}">


            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <Image x:Name="ImageElement"
                               x:FieldModifier="public"
                               Tapped="ImageElement_Tapped"
                               DoubleTapped="ImageElement_DoubleTapped"
                               RightTapped="ImageElement_RightTapped"
                               ImageOpened="ImageElement_ImageOpened"
                               DragStarting="ImageElement_DragStarting"
                               Tag="{Binding ElementName=ImageMediaButton}"
                               MaxWidth="{Binding ElementName=VisualPlayerImageScrollViewer, Path=ViewportWidth, Mode=OneWay}"
                               MaxHeight="{Binding ElementName=VisualPlayerImageScrollViewer, Path=ViewportHeight, Mode=OneWay}"
                               Stretch="Uniform"
                               HorizontalAlignment="Stretch"
                               VerticalAlignment="Stretch"
                               CanDrag="True"
                               MinWidth="0"
                               MinHeight="0"
                               RenderTransformOrigin="0.5,0.5">
                    <Image.RenderTransform>
                        <RotateTransform x:Name="ImageRotation" Angle="0"/>
                    </Image.RenderTransform>
                </Image>

                <local:MediaButton x:Name="ImageMediaButton"/>
            </Grid>

        </ScrollViewer>

        <MediaPlayerElement x:Name="VideoElement" 
                            x:FieldModifier="public">

            <MediaPlayerElement.TransportControls>
                <ext:CustomMediaTransportControls x:Name="TransportControls" 
                    IsCompact="False"
                         
                    IsSeekBarVisible="True"
                    IsVolumeButtonVisible="True"
                    IsVolumeEnabled="True"
                    IsNextTrackButtonVisible="False"
                    IsPreviousTrackButtonVisible="False"
                    IsFastRewindButtonVisible="True"
                    IsFastRewindEnabled="True"
                    IsFastForwardButtonVisible="True"
                    IsFastForwardEnabled="True"
                    IsRepeatButtonVisible="True"
                    IsRepeatEnabled="True"                                       
                    IsPlaybackRateButtonVisible="True"
                    IsPlaybackRateEnabled="True"
                    Liked="TransportControls_Liked"
                    RepeatToggled="TransportControls_RepeatToggled"
                    MarkIn="TransportControls_MarkIn"
                    MarkOut="TransportControls_MarkOut">

                </ext:CustomMediaTransportControls>
            </MediaPlayerElement.TransportControls>



            <MediaPlayerElement.Style>
                <Style TargetType="MediaPlayerElement">
                    <Setter Property="HorizontalAlignment" Value="Stretch" />
                    <Setter Property="VerticalAlignment" Value="Stretch" />
                    <Setter Property="IsTabStop" Value="False" />
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="MediaPlayerElement">
                                <Grid x:Name="LayoutRoot"
                                      HorizontalAlignment="Stretch" 
                                      VerticalAlignment="Stretch">

                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="2*"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <!--<Border Background="Transparent" />-->
                                    <Image
                                        x:Name="PosterImage"
                                        Source="{TemplateBinding PosterSource}"
                                        Stretch="{TemplateBinding Stretch}"
                                        Visibility="Collapsed"
                                        Grid.RowSpan="2"/>

                                    <!--Allows the video to be moved freely when the scroll view is moved inside-->
                                    <local:VisualCanvas x:Name="FreeMoveVideoCanvas"
                                        PointerPressed="FreeMoveCanvas_PointerPressed"
                                        PointerMoved="FreeMoveCanvas_PointerMoved"
                                        PointerReleased="FreeMoveCanvas_PointerReleased"
                                        PointerExited="FreeMoveCanvas_PointerReleased"
                                        Tag="{Binding ElementName=VisualPlayerVideoScrollViewer}"
                                        HorizontalAlignment="Stretch"
                                        VerticalAlignment="Stretch"
                                        Grid.RowSpan="2">
                                    </local:VisualCanvas>

                                    <!--Displays the video inside a scroll view to allow zooming and panning-->
                                    <ScrollViewer x:Name="VisualPlayerVideoScrollViewer"
                                          HorizontalScrollMode="Disabled"
                                          VerticalScrollMode="Disabled"
                                          HorizontalScrollBarVisibility="Hidden"
                                          VerticalScrollBarVisibility="Hidden"
                                          Loaded="VideoScrollViewer_Loaded"
                                          PointerPressed="ScrollViewer_PointerPressed"
                                          PointerEntered="ScrollViewer_PointerEntered"
                                          PointerExited="ScrollViewer_PointerExited"
                                          PointerReleased="ScrollViewer_PointerReleased"
                                          PointerMoved="ScrollViewer_PointerMoved"
                                          LostFocus="ScrollViewer_LostFocus"  
                                          ZoomMode="Enabled"
                                          Grid.RowSpan="2"
                                          Tag="{Binding ElementName=FreeMoveVideoCanvas}">

                                        <Viewbox x:Name="VisualPlayerViewBox" 
                                                 Stretch="Uniform" 
                                                 StretchDirection="DownOnly" 
                                                 HorizontalAlignment="Center" 
                                                 VerticalAlignment="Center"
                                                 MaxWidth="{Binding ElementName=VisualPlayerVideoScrollViewer, Path=ViewportWidth, Mode=OneWay}"
                                                 MaxHeight="{Binding ElementName=VisualPlayerVideoScrollViewer, Path=ViewportHeight, Mode=OneWay}">

                                            <Grid Tapped="VisualPlayerPresenter_Tapped"
                                                  DoubleTapped="VisualPlayerPresenter_DoubleTapped"
                                                  RightTapped="VisualPlayerPresenter_RightTapped"
                                                  Tag="{Binding ElementName=VisualPlayerPresenter}"                                             
                                                  Background="Transparent"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center">
                                                <MediaPlayerPresenter
                                                    x:Name="VisualPlayerPresenter"   
                                                    Tag="{Binding ElementName=VideoMediaButton}"
                                                    IsFullWindow="{TemplateBinding IsFullWindow}"
                                                    MediaPlayer="{TemplateBinding MediaPlayer}"  
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"/>
                                            </Grid>

                                        </Viewbox>
                                    </ScrollViewer>

                                    <local:MediaButton x:Name="VideoMediaButton" Grid.RowSpan="2"/>

                                    <!--Displays the Transport controls for the video-->
                                    <ContentPresenter Grid.RowSpan="2"
                                            x:Name="TransportControlsPresenter" VerticalAlignment="Bottom"
                                            Visibility="{TemplateBinding AreTransportControlsEnabled}">
                                    </ContentPresenter>

                                    <Grid x:Name="TimedTextSourcePresenter" Grid.RowSpan="2" />
                                </Grid>

                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>



            </MediaPlayerElement.Style>
        </MediaPlayerElement>

        <ProgressRing x:Name="LoadRing" 
                      IsActive="True"
                      VerticalAlignment="Center"
                      HorizontalAlignment="Center"
                      Height="50"
                      Width="50"/>

        <!-- Clipboard Copy Feedback Overlay -->
        <Border x:Name="ClipboardFeedbackOverlay"
                Background="{ThemeResource ClipboardBackground}"
                Opacity="0"
                IsHitTestVisible="False"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border.RenderTransform>
                <ScaleTransform x:Name="ClipboardFeedbackScale" 
                                ScaleX="1" 
                                ScaleY="1" 
                                CenterX="0.5" 
                                CenterY="0.5"/>
            </Border.RenderTransform>
        </Border>

    </Grid>

</UserControl>